<!DOCTYPE html>
<html lang="pt-br">
<head>
  <meta charset="UTF-8" />
  <title>alfaPIX - Pagamento via Pix</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
  <style>
    /* CSS Atualizado com Anima√ß√£o */
    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      background-color: #f4f7fa;
      display: flex;
      flex-direction: column;
      align-items: center;
      padding: 40px 20px;
    }

    h1 {
      color: #0077cc;
      font-size: 2.5em;
      margin-bottom: 10px;
    }

    form {
      background: #fff;
      padding: 20px 30px;
      border-radius: 12px;
      box-shadow: 0 0 10px rgba(0,0,0,0.08);
      display: flex;
      gap: 10px;
      align-items: center;
    }

    input[type="number"] {
      padding: 8px;
      border-radius: 6px;
      border: 1px solid #ccc;
      width: 120px;
    }

    button {
      padding: 8px 16px;
      border: none;
      color: white;
      border-radius: 6px;
      cursor: pointer;
    }

    .btn-azul { background-color: #0077cc; }
    .btn-verde { background-color: #28a745; }
    .btn-vermelho { background-color: #e74c3c; }
    .btn-cinza { background-color: #6c757d; }

    #resultado {
      margin-top: 30px;
      text-align: center;
      display: none;
    }

    #qrcode {
      max-width: 220px;
      border: 8px solid white;
      box-shadow: 0 0 12px rgba(0,0,0,0.15);
      border-radius: 12px;
    }

    #status {
      font-weight: bold;
      margin-top: 15px;
    }

    #alerta {
      margin-top: 15px;
    }

    .alert {
      padding: 10px 15px;
      border-radius: 8px;
      font-weight: bold;
      width: 100%;
      max-width: 400px;
      text-align: center;
    }

    .success {
      background-color: #d4edda;
      color: #155724;
      border: 1px solid #c3e6cb;
    }

    .error {
      background-color: #f8d7da;
      color: #721c24;
      border: 1px solid #f5c6cb;
    }

    #notificacao-pagamento {
      position: fixed;
      top: 20px;
      left: 50%;
      transform: translateX(-50%);
      background-color: #28a745;
      color: white;
      padding: 15px 30px;
      border-radius: 8px;
      font-weight: bold;
      box-shadow: 0 0 15px rgba(40, 167, 69, 0.7);
      opacity: 0;
      pointer-events: none;
      transition: opacity 0.5s ease;
      z-index: 9999;
    }

    #notificacao-pagamento.show {
      opacity: 1;
      pointer-events: auto;
    }

    #lista-pix {
      margin-top: 20px;
      width: 100%;
      max-width: 400px;
      background: #fff;
      padding: 15px;
      border-radius: 8px;
      border: 2px solid #0077cc;
    }

    #lista-pix h3 {
      text-align: center;
      color: #0077cc;
      margin-bottom: 10px;
    }

    #historico-pix {
      list-style: none;
      padding: 0;
    }

    #historico-pix li {
      background: #f9f9f9;
      padding: 8px;
      margin-bottom: 8px;
      border-radius: 6px;
      box-shadow: 0 0 6px rgba(0,0,0,0.1);
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    #limpar-lista {
      margin-top: 10px;
      display: block;
      width: 100%;
      max-width: 400px;
      text-align: center;
    }

    /* Anima√ß√£o no bot√£o de "Nova cobran√ßa" */
    @keyframes pulse {
      0% { transform: scale(1); }
      50% { transform: scale(1.1); }
      100% { transform: scale(1); }
    }

    .btn-pulse {
      animation: pulse 1s infinite;
    }

    /* Transi√ß√µes para fade-in/fade-out */
    #qrcode, #verificar-btn, #status {
      transition: opacity 0.5s ease-in-out;
    }

    #cancelar-btn {
      transition: opacity 0.5s ease-in-out;
    }

    /* Estilo para nova cobran√ßa com anima√ß√£o */
    #nova-cobranca {
      opacity: 0;
      visibility: hidden;
      transition: opacity 0.5s ease-in-out, visibility 0.5s ease-in-out;
    }

    #nova-cobranca.show {
      opacity: 1;
      visibility: visible;
    }
  </style>
</head>
<body>

<h1>alfaPIX</h1>

<form id="form-cobrar">
  <label>Valor (R$):</label>
  <input type="number" name="valor" step="0.01" required />
  <button type="submit" class="btn-azul">Gerar cobran√ßa</button>
</form>

<div id="resultado">
  <h3 id="titulo-qrcode">QR Code:</h3>
  <img id="qrcode" src="" alt="QR Code Pix" />
  <input type="hidden" id="txid" />
  <br /><br />
  <button id="verificar-btn" class="btn-azul">Verificar pagamento</button>
  <button id="cancelar-btn" class="btn-vermelho">Cancelar</button>
  <p id="status"></p>
</div>

<div id="lista-pix">
  <h3>üì• Pagamentos Recebidos</h3>
  <ul id="historico-pix"></ul>
</div>

<button id="limpar-lista" class="btn-cinza">üóëÔ∏è Limpar Lista</button>

<div id="alerta"></div>
<div id="notificacao-pagamento">‚úÖ Pagamento confirmado!</div>

<audio id="som-confirmacao" preload="auto">
  <source src="https://cdn.pixabay.com/download/audio/2021/08/04/audio_2f95719a29.mp3?filename=correct-2-46134.mp3" type="audio/mpeg">
</audio>

<script>
let intervalo;
let historicoPagamentos = JSON.parse(localStorage.getItem('historicoPagamentos')) || [];

function atualizarListaPagamentos() {
  const lista = $('#historico-pix');
  lista.empty();

  if (historicoPagamentos.length > 0) {
    historicoPagamentos.forEach(p => {
      lista.append(`<li><span>‚úÖ R$ ${parseFloat(p.valor).toFixed(2)}</span> <small>${p.dataHora}</small></li>`);
    });
  } else {
    lista.append('<li style="text-align:center; color: #888;">Nenhum pagamento registrado ainda.</li>');
  }

  $('#lista-pix').fadeIn();
  $('#limpar-lista').show();
}

function salvarHistorico() {
  localStorage.setItem('historicoPagamentos', JSON.stringify(historicoPagamentos));
}

$('#form-cobrar').on('submit', function(e) {
  e.preventDefault();
  $('#alerta').html('');
  $('#qrcode').show();
  $('#verificar-btn').show();
  $('#cancelar-btn').text('Cancelar').show();

  $.post('/cobrar', $(this).serialize(), function(data) {
    if (data.qrcode && data.txid) {
      $('#qrcode').attr('src', data.qrcode);
      $('#txid').val(data.txid);
      $('#resultado').fadeIn();
      $('#status').text('Aguardando pagamento...');

      if (intervalo) clearInterval(intervalo);
      intervalo = setInterval(verificarPagamento, 5000);
    } else {
      mostrarAlerta('Erro ao gerar cobran√ßa.', 'error');
    }
  }).fail(() => {
    mostrarAlerta('Erro na comunica√ß√£o com o servidor.', 'error');
  });
});

function verificarPagamento() {
  const txid = $('#txid').val();
  $.post('/verificar', { txid }, function(data) {
    const statusMap = {
      'ATIVA': 'Aguardando pagamento',
      'CONCLUIDA': 'Pagamento recebido com sucesso',
      'REMOVIDA_PELO_USUARIO_RECEBEDOR': 'Cobran√ßa cancelada',
      'EXPIRADA': 'Cobran√ßa expirada',
    };
    const statusTexto = statusMap[data.status] || data.status;
    $('#status').text('Status: ' + statusTexto);

    if (data.status === 'CONCLUIDA') {
      clearInterval(intervalo);
      mostrarNotificacao('‚úÖ Pagamento confirmado!');
      mostrarAlerta('‚úÖ Pagamento confirmado!', 'success');
      document.getElementById('som-confirmacao').play().catch(err => {
        console.warn('Som bloqueado pelo navegador. Usu√°rio precisa interagir com a p√°gina.');
      });

      const valor = $('input[name="valor"]').val();
      const dataHora = new Date().toLocaleString();
      historicoPagamentos.push({ valor, dataHora });
      salvarHistorico();
      atualizarListaPagamentos();

      // Adicionando anima√ß√£o para transi√ß√£o
      $('#titulo-qrcode').fadeOut(500); // Fade out do t√≠tulo do QR Code
      $('#qrcode').fadeOut(500);        // Fade out do QR Code
      $('#verificar-btn').fadeOut(500); // Fade out do bot√£o de verifica√ß√£o
      $('#status').fadeOut(500);        // Fade out do status

      // Exibir o bot√£o de "Nova Cobran√ßa"
      setTimeout(() => {
        $('#cancelar-btn')
          .removeClass('btn-vermelho')
          .addClass('btn-verde btn-pulse')
          .text('üîÑ Nova cobran√ßa')
          .fadeIn(500) // Fade-in do bot√£o de Nova Cobran√ßa
          .addClass('show'); // Adiciona a classe 'show' para mostrar o bot√£o
      }, 500); // Atraso para o efeito de transi√ß√£o
    }
  }).fail(() => {
    mostrarAlerta('Erro ao verificar pagamento.', 'error');
  });
}

$('#cancelar-btn').on('click', function () {
  // Anima√ß√£o de transi√ß√£o de volta para o estado inicial
  $('#resultado').fadeOut(500, function() {
    // Ap√≥s o fade-out, resetar o formul√°rio e ocultar a confirma√ß√£o
    $('#form-cobrar')[0].reset();
    $('#alerta').html('');
    $('#qrcode').attr('src', '').hide();
    $('#status').text('');
    $('#cancelar-btn').removeClass('btn-verde btn-pulse').addClass('btn-vermelho').text('Cancelar').hide();
    $('#form-cobrar').fadeIn(500); // Fade-in para o formul√°rio de novo pedido
  });
  atualizarListaPagamentos();
});

$('#limpar-lista').on('click', function () {
  if (confirm("Deseja limpar todo o hist√≥rico de pagamentos?")) {
    historicoPagamentos = [];
    salvarHistorico();
    atualizarListaPagamentos();
  }
});

function mostrarAlerta(msg, tipo) {
  $('#alerta').html(`<div class="alert ${tipo}">${msg}</div>`);
}

function mostrarNotificacao(msg) {
  const notif = $('#notificacao-pagamento');
  notif.text(msg).addClass('show');
  setTimeout(() => notif.removeClass('show'), 4000);
}

// Inicializa lista ao carregar
$(document).ready(() => {
  atualizarListaPagamentos();
});
</script>
</body>
</html>
